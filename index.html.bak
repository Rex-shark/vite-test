<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>手機控制器</title>
    <style>
        body { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; font-family:Arial,"微軟正黑體"; background:#111; color:#fff; margin:0;}
        h2 { margin-bottom: 20px; }
        #controls { display:flex; flex-wrap:wrap; width:200px; justify-content:center; gap:10px;}
        button { width:80px; height:80px; font-size:20px; border-radius:12px; border:none; background:#2d8cff; color:#fff;}
        .status { margin-top:20px; padding:6px 12px; background:#222; border-radius:6px;}
        /* 新增樣式 */
        #exportArea { width:320px; max-width:90vw; min-height:100px; margin-top:12px; padding:8px; border-radius:8px; border:1px solid #333; background:#0f1720; color:#fff; }
        #saveTxtBtn { width:160px; height:44px; font-size:16px; border-radius:8px; margin-top:8px; }
        #saveStatus { margin-top:8px; padding:6px 10px; background:#1b2328; border-radius:6px; }
    </style>
</head>
<body>

<h2>手機搖桿控制器</h2>

<div id="controls">
    <button id="up">↑</button>
    <button id="left">←</button>
    <button id="down">↓</button>
    <button id="right">→</button>
</div>

<div class="status">連線狀態：<span id="wsStatus">未連線</span></div>




<script>
    const WS_URL = "ws://127.0.0.1:8080/ws/game"; // 改成你的電腦 IP
    let ws = null;
    const wsStatusEl = document.getElementById("wsStatus");

    //File System Access API


    // 連線 WebSocket
    function connectWS() {
        ws = new WebSocket(WS_URL);
        wsStatusEl.textContent = "連線中...";
        ws.onopen = () => { wsStatusEl.textContent="已連線"; console.log("WS connected"); };
        ws.onclose = () => { wsStatusEl.textContent="已斷線"; console.log("WS closed"); };
        ws.onerror = (e) => { wsStatusEl.textContent="錯誤"; console.error("WS error:", e); };
        ws.onmessage = (msg) => console.log("收到訊息:", msg.data);
    }
    connectWS();

    // 按鈕事件
    document.getElementById("up").addEventListener("click", ()=>sendCmd("MOVE_UP"));
    document.getElementById("down").addEventListener("click", ()=>sendCmd("MOVE_DOWN"));
    document.getElementById("left").addEventListener("click", ()=>sendCmd("MOVE_LEFT"));
    document.getElementById("right").addEventListener("click", ()=>sendCmd("MOVE_RIGHT"));

    function sendCmd(cmd){
        if(ws && ws.readyState===WebSocket.OPEN){
            ws.send(cmd);
            console.log("Sent:", cmd);
        }
    }

    // File Save implementation
    const exportArea = document.getElementById('exportArea');
    const saveBtn = document.getElementById('saveTxtBtn');
    const saveMsgEl = document.getElementById('saveMsg');

    function showInfo(msg){
        saveMsgEl.textContent = msg;
        saveMsgEl.style.color = '#8fd68f';
    }
    function showError(msg){
        saveMsgEl.textContent = msg;
        saveMsgEl.style.color = '#ff7b7b';
    }

    // 防重入鎖
    let saving = false;

    saveBtn.addEventListener('click', async ()=>{
        await handleSaveTxt();
    });

    async function handleSaveTxt(){
        if(saving) return;
        saving = true;
        saveBtn.disabled = true;
        showInfo('儲存中...');

        const text = exportArea.value || '';
        if(!text){
            showError('沒有內容可儲存');
            saving = false;
            saveBtn.disabled = false;
            return;
        }

        try{
            // 在支援的環境下使用 showSaveFilePicker
            if(window.showSaveFilePicker){
                const opts = {
                    types: [{ description: 'Text File', accept: { 'text/plain': ['.txt'] } }],
                    suggestedName: 'notes.txt',
                    startIn: 'downloads'
                };
                // 需在使用者手勢下呼叫（由 click 事件觸發）
                const handle = await window.showSaveFilePicker(opts);

                // optional: 檢查/請求權限
                try{
                    const perm = await handle.queryPermission({ mode: 'readwrite' });
                    if(perm !== 'granted'){
                        const req = await handle.requestPermission({ mode: 'readwrite' });
                        if(req !== 'granted'){
                            throw new Error('無寫入權限：使用者拒絕授權');
                        }
                    }
                }catch(e){
                    // 某些實作可能不提供 queryPermission，忽略非致命錯誤
                    console.warn('permission check skipped or failed:', e);
                }

                const writable = await handle.createWritable();
                await writable.write(text);
                await writable.close();
                showInfo('已成功匯出檔案。');

            }else{
                // fallback: 建立 Blob 並觸發下載
                const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'notes.txt';
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                showInfo('瀏覽器不支援直接寫入檔案，已使用下載方式替代。');
            }
        }catch(e){
            // 處理使用者取消或權限拒絕
            console.error('Save failed:', e);
            if(e && (e.name === 'AbortError' || e.name === 'NotAllowedError' || (e.message && e.message.includes('拒絕')))){
                showInfo('已取消儲存動作。');
            } else {
                showError('儲存失敗：' + (e && (e.message || e.name) || '未知錯誤'));
            }
        }finally{
            saving = false;
            saveBtn.disabled = false;
        }
    }

</script>

</body>
</html>

